{% extends "user_dashboard.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/create_invoice.css' %}">
<script src="{% static 'js/create_invoice.js' %}"></script>
<script src="{% static 'js/invoice.js' %}"></script>
{% endblock css %}

{% block dashboard_content %}
<div class="invoice-container">
    <header>
        <img src="{% if logo %} {{ logo.logo.url }} {%else%} {% static 'images/logo.jpeg' %} {% endif %}" alt="Bhada Pay Logo" class="logo">
        <h1 class="invoice-title">Rent Invoice</h1>
    </header>

    <!-- Displaying success or error messages dynamically -->
    <div class="container">
        {% if form.errors %}
            <div id="messages" class="message-container">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <div class="alert alert-danger">
                            {{ field|capfirst }}: {{ error }}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    
    <form class="form" method="POST" action="">
        {% csrf_token %}
        
        <!-- Section 1 -->
        <div class="section flex">
            <div>
                <label>बहाल महिना: {{ form.rent_month }}</label>
                {% if form.rent_month.errors %}
                    <div class="text-danger">{{ form.rent_month.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label>मिति:</label>
                <input type="text" class="date-picker" id="nepaliDate" name="nepali_date" placeholder="YYYY-MM-DD" required>
                {{ form.date }}
                {% if form.date.errors %}
                    <div class="text-danger">{{ form.date.errors }}</div>
                {% endif %}
            </div>
        </div>
    
        <!-- Section 2 -->
        <div class="section" style="border: 1px solid black; padding: 10px; border-radius: 15px;">
            <div>
                <label>बहालवालाको नाम: {{ form.tenant }}</label>
                {% if form.tenant.errors %}
                    <div class="text-danger">{{ form.tenant.errors }}</div>
                {% endif %}
            </div>
    
            <h3 class="section-title">बहालको विवरण</h3>
            <div class="section flex">
                <div>
                    <label>घर नं.: {{ form.house_number }}</label>
                    {% if form.house_number.errors %}
                        <div class="text-danger">{{ form.house_number.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>फ्ल्याट नं.: {{ form.flat_number }}</label>
                    {% if form.flat_number.errors %}
                        <div class="text-danger">{{ form.flat_number.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>कोठा, सटर, पसल, अन्य नं.: {{ form.room_no }}</label>
                    {% if form.room_no.errors %}
                        <div class="text-danger">{{ form.room_no.errors }}</div>
                    {% endif %}
                </div>
            </div>
    
            <div>
                <label>घर, बिल्डिङ, अपार्टमेन्ट, बंगला नाम वा नम्बर: {{ form.building_name }}</label>
                {% if form.building_name.errors %}
                    <div class="text-danger">{{ form.building_name.errors }}</div>
                {% endif %}
            </div>
            <div>
                <label>पान नं./ भ्याट नं.: {{ form.pan_or_vat_number }}</label>
                {% if form.pan_or_vat_number.errors %}
                    <div class="text-danger">{{ form.pan_or_vat_number.errors }}</div>
                {% endif %}
            </div>
        </div>
    
        <!-- Section 3: Rent Details -->
        <div class="section" style="border: 1px solid black; padding: 10px; border-radius: 15px;">
            <h3 class="section-title">सुल्क विवरण</h3>
            <div class="section grid-two">
                <div>
                    <label>बहाल रकम: {{ form.rent_amount }}</label>
                    {% if form.rent_amount.errors %}
                        <div class="text-danger">{{ form.rent_amount.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>पार्किङ: {{ form.parking_fee }}</label>
                    {% if form.parking_fee.errors %}
                        <div class="text-danger">{{ form.parking_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>बिजुली: {{ form.electricity_fee }}</label>
                    {% if form.electricity_fee.errors %}
                        <div class="text-danger">{{ form.electricity_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>पिउने पानी : {{ form.drinking_water_fee }}</label>
                    {% if form.drinking_water_fee.errors %}
                        <div class="text-danger">{{ form.drinking_water_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>साधारण पानी  : {{ form.normal_water_fee }}</label>
                    {% if form.normal_water_fee.errors %}
                        <div class="text-danger">{{ form.normal_water_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>फोहोर सरसफाई   : {{ form.waste_fee }}</label>
                    {% if form.waste_fee.errors %}
                        <div class="text-danger">{{ form.waste_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>सुरक्षा गार्ड: {{ form.security_fee }}</label>
                    {% if form.security_fee.errors %}
                        <div class="text-danger">{{ form.security_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>जेनेरेटर, पावर ब्याकप : {{ form.generator_power_backup_fee }}</label>
                    {% if form.generator_power_backup_fee.errors %}
                        <div class="text-danger">{{ form.generator_power_backup_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>ईन्टरनेट, टेलिफोन, टिभी  : {{ form.internet_telephone_tv_fee }}</label>
                    {% if form.internet_telephone_tv_fee.errors %}
                        <div class="text-danger">{{ form.internet_telephone_tv_fee.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>अन्य खर्च: {{ form.other_fee }}</label>
                    {% if form.other_fee.errors %}
                        <div class="text-danger">{{ form.other_fee.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    
        <!-- Section 4: Total Calculation -->
        <div class="section" style="border: 1px solid black; padding: 10px; border-radius: 15px;">
            <h3 class="section-title">जम्मा हिसाबको विवरण</h3>
            <div class="section grid-two">
                <div>
                    <label>छुट रकम: {{ form.discount }}</label>
                    {% if form.discount.errors %}
                        <div class="text-danger">{{ form.discount.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>जम्मा रकम: {{ form.total_amount }}</label>
                    {% if form.total_amount.errors %}
                        <div class="text-danger">{{ form.total_amount.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>बहाल कर: {{ form.tax }}</label>
                    {% if form.tax.errors %}
                        <div class="text-danger">{{ form.tax.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>कुल जम्मा रकम: {{ form.grand_total }}</label>
                    {% if form.grand_total.errors %}
                        <div class="text-danger">{{ form.grand_total.errors }}</div>
                    {% endif %}
                </div>
                <div id="previous-due">
                    <label>अगाडिको बाँकी रकम : {{ form.previous_due }}</label>
                    {% if form.previous_due.errors %}
                        <div class="text-danger">{{ form.previous_due.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    
        <!-- Section 5: Bank Details -->
        <div style="border: 1px solid black; padding: 10px; border-radius: 15px;">
            <h3 class="section-title">बैंक विवरण</h3>
            <div class="section">
                <div>
                    <label>बैंक नाम: {{ form.bank_name }}</label>
                    {% if form.bank_name.errors %}
                        <div class="text-danger">{{ form.bank_name.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>खाता नम्बर: {{ form.account_number }}</label>
                    {% if form.account_number.errors %}
                        <div class="text-danger">{{ form.account_number.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>खाता नाम: {{ form.account_name }}</label>
                    {% if form.account_name.errors %}
                        <div class="text-danger">{{ form.account_name.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    
        <!-- Section 6: Signatures -->
        <div style="border: 1px solid black; padding: 10px; border-radius: 15px; margin-top: 20px;">
            <h3 class="section-title">हस्ताक्षर</h3>
            <div class="section grid-two">
                <div>
                    <label>बहाल धनि हस्ताक्षर: {{ form.owner_signature }}</label>
                    {% if form.owner_signature.errors %}
                        <div class="text-danger">{{ form.owner_signature.errors }}</div>
                    {% endif %}
                </div>
                <div>
                    <label>बहाल वाला हस्ताक्षर: {{ form.tenant_signature }}</label>
                    {% if form.tenant_signature.errors %}
                        <div class="text-danger">{{ form.tenant_signature.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    
        <p class="note">नोट : हरेक महिनाको ......गते भित्र भाडा र अन्य महशुल बुझाउनुपर्ने छ, अन्यथा ...... प्रतिशत जरिवाना लाग्नेछ ।  </p>
    
        <button type="submit" class="submit-btn">पेश गर्नुहोस्</button>
    </form>
</div>

<!-- this should go after your </body> -->
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/nepali-date-picker@2.0.2/dist/nepaliDatePicker.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://unpkg.com/nepali-date-picker@2.0.2/dist/nepaliDatePicker.min.css" crossorigin="anonymous" />
<script src="https://cdn.jsdelivr.net/npm/nepali-date-converter@2.2.0/dist/nepali-date-converter.umd.js"></script>

<script>
    $(document).ready(function() {
        $('#nepaliDate').nepaliDatePicker({
            dateFormat: '%y-%m-%d',
            closeOnDateSelect: true
        });

        // Handle tenant dropdown change
        $('#id_tenant').change(function() {
            var tenantId = $(this).val();
            if (tenantId) {
                $.ajax({
                    url: "{% url 'invoices:get_tenant_details' %}",
                    type: 'GET',
                    data: { tenant_id: tenantId },
                    success: function(data) {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        // Populate the fields
                        $('#id_house_number').val(data.house_name);
                        $('#id_flat_number').val(data.flat_number);
                        $('#id_room_no').val(data.room_number);
                        $('#id_building_name').val(data.house_name);
                        $('#id_pan_or_vat_number').val(data.pan_or_vat_number);
                        $('#id_rent_amount').val(data.rent_amount);
                        $('#id_date').val(data.rent_start_date);
                        $('#nepaliDate').val(data.rent_start_date);
                        $(document).trigger('input'); // Trigger total calculation
                    },
                    error: function(xhr) {
                        alert('Error fetching tenant details: ' + xhr.responseJSON.error);
                    }
                });
            } else {
                // Clear fields if no tenant is selected
                $('#id_house_number').val('');
                $('#id_flat_number').val('');
                $('#id_room_no').val('');
                $('#id_building_name').val('');
                $('#id_pan_or_vat_number').val('');
                $('#id_rent_amount').val('');
                $('#id_date').val('');
                $('#nepaliDate').val('');
                $(document).trigger('input');
            }
        });
    });
</script>
{% endblock dashboard_content %}